{
    "version": "0.0.1",
    "description": "安装archlinux",
    "homepage": "https://gitlab.archlinux.org/archlinux/archlinux-wsl",
    "license": "Freeware",
    "depends": ["Chuckie_s/microsoft-wsl", "Chuckie_s/wsldl_arch"],
    "architecture": {
        "64bit": {
            "url": "https://mirrors.tuna.tsinghua.edu.cn/archlinux/wsl/latest/archlinux.wsl"
        }
    },
    "pre_install": [
        "if ($null -eq (Get-Command 'wslconfig' -ErrorAction SilentlyContinue)) {",
        "    warn 'WSL appears not to be enabled!'",
        "    warn 'Run ''Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux'''",
        "    warn 'from an elevated PowerShell. Restart your computer when prompted and reinstall ArchWSL.'",
        "    error \"$app requires WSL to run\"",
        "    break",
        "}"
    ],
    "installer": {
        "script": [
            "& Arch 'isregd'",
            "if ($?) {",
            "    Write-Host 'ArchWsl is already registered.'",
            "    warn 'ArchWsl is already registered'",
            "    break",
            "}",
            "ensure \"$persist_dir\\data\" | Out-Null",
            "Copy-Item \"$(appdir wsldl_arch $global)\\current\\Arch.exe\" \"$persist_dir\\data\\Arch.exe\"",
            "$res = Invoke-ExternalCommand \"$persist_dir\\data\\Arch.exe\" 'install', \"$dir\\archlinux.wsl\"",
            "Remove-Item \"$persist_dir\\data\\Arch.exe\" -Force",
            "if(!$res) { error 'ArchWsl installation failed!'; return }"
        ]
    },
    "post_install": [
        "Remove-Item \"$dir\\archlinux.wsl\" -Force -ErrorAction SilentlyContinue",
        "function Convert-WindowsPathToWslPath {",
        "    param (",
        "        [Parameter(Mandatory)]",
        "        [string]$WindowsPath",
        "    )",
        "    $cleanPath = $WindowsPath.Trim('\"') -replace '\\\\', '/'",
        "    if ($cleanPath -match '^([A-Za-z]):/(.*)') {",
        "        $drive = $matches[1].ToLower()",
        "        $rest = $matches[2]",
        "        return \"/mnt/$drive/$rest\"",
        "    } else {",
        "        throw \"file path not in a valid format (e.g. C:\\path\\to\\file)\"",
        "    }",
        "}",
        "$script_path = Convert-WindowsPathToWslPath \"$bucketsdir\\Chuckie_s\\scripts\\my_archlinux\\init_archlinux.sh\"",
        "wsl --distribution Arch bash -c $script_path"
    ],
    "uninstaller": {
        "script": [
            "if ($cmd -ne 'uninstall') { return }",
            "$res = Invoke-ExternalCommand Arch 'isregd'",
            "if(!$res) { error 'ArchWsl is not registered!'; return }",
            "Invoke-ExternalCommand Arch 'clean', '-y' | Out-Null"
        ]
    },
    "persist": "data"
}
